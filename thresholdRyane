import matplotlib.pyplot as plt
import numpy as np
from PIL import Image
from astropy.stats import mad_std
from sklearn.preprocessing import MinMaxScaler
from collections import deque

# Charger l'image
image = Image.open('cassio.png').convert('L')  # Convertir en niveau de gris
image_array = np.array(image, dtype=float)  # Convertir en tableau numpy
image_array /= image_array.max()  # Normaliser entre 0 et 1

# Détection des étoiles avec un seuil
sigma = mad_std(image_array)*6
threshold_mask = image_array > (5.0 * sigma)
plt.imshow(threshold_mask, cmap='gray', origin='lower')
plt.title('Thresholded Image With Stars (Red Points)')
plt.show()

print(sigma)

# Fonction pour trouver les points adjacents
def détermine_points_adjacents(point, max_i, max_j):
    i, j = point
    adjacents = []
    for di, dj in [(-1, 0), (1, 0), (0, -1), (0, 1), (-1, -1), (-1, 1), (1, -1), (1, 1)]:
        ni, nj = i + di, j + dj
        if 0 <= ni < max_i and 0 <= nj < max_j:
            adjacents.append((ni, nj))
    return adjacents

# Fonction pour créer une forme
def crée_une_forme(start, threshold_mask, explored):
    max_i, max_j = threshold_mask.shape
    queue = deque([start])
    forme = []
    while queue:
        point = queue.popleft()
        if explored[point]:
            continue
        explored[point] = True
        forme.append(point)
        for adj in détermine_points_adjacents(point, max_i, max_j):
            if not explored[adj] and threshold_mask[adj]:
                queue.append(adj)
    return forme

# Fonction pour trouver toutes les formes
def détermine_formes(threshold_mask):
    explored = np.zeros_like(threshold_mask, dtype=bool)
    formes = []
    max_i, max_j = threshold_mask.shape
    for i in range(max_i):
        for j in range(max_j):
            if threshold_mask[i, j] and not explored[i, j]:
                formes.append(crée_une_forme((i, j), threshold_mask, explored))
    return formes

# Calculer les coordonnées des étoiles
def détermine_coordonnées_étoiles(formes):
    cor = []
    for forme in formes:
        points = np.array(forme)
        barycentre = points.mean(axis=0)
        cor.append(barycentre)
    return cor

# Afficher les étoiles détectées
def affichelesétoiles():
    formes = détermine_formes(threshold_mask)
    coordonnéesdesétoiles = détermine_coordonnées_étoiles(formes)
    plt.imshow(threshold_mask, cmap='gray', origin='lower')
    plt.title('Thresholded Image With Stars (Red Points)')
    for star in coordonnéesdesétoiles:
        plt.plot(star[1], star[0], 'ro')  # Inverser les indices pour matplotlib
    plt.show()

affichelesétoiles()
